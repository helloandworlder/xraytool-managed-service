#!/usr/bin/env bash
set -euo pipefail

if [[ "${EUID}" -ne 0 ]]; then
  echo "Please run as root (sudo)."
  exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
SERVICE_NAME="xraytool"
ENV_FILE="/etc/default/${SERVICE_NAME}"
UNIT_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
CTL_BIN="${ROOT_DIR}/xraytoolctl"
PUBLIC_INSTALLER="${SCRIPT_DIR}/public-install.sh"
REPO_INSTALLER_URL="https://raw.githubusercontent.com/helloandworlder/xraytool-managed-service/refs/heads/main/deploy/public-install.sh"

random_alnum() {
  local n="$1"
  (set +o pipefail; LC_ALL=C tr -dc 'A-Za-z0-9' < /dev/urandom | head -c "$n")
}

read_env_var() {
  local key="$1"
  [[ -f "${ENV_FILE}" ]] || return 0
  awk -F'=' -v k="$key" '$1==k {print substr($0, index($0,$2)); exit}' "${ENV_FILE}"
}

get_install_dir() {
  local data_dir
  data_dir="$(read_env_var XTOOL_DATA_DIR || true)"
  if [[ -n "${data_dir}" ]]; then
    dirname "${data_dir}"
    return
  fi
  echo "${ROOT_DIR}"
}

PORT_RAW="$(read_env_var XTOOL_LISTEN || true)"
if [[ -n "${PORT_RAW}" ]]; then
  PORT_RAW="${PORT_RAW#:}"
fi
if [[ -z "${PORT_RAW}" ]]; then
  PORT_RAW="18080"
fi
ADMIN_USER="$(read_env_var XTOOL_ADMIN_USER || true)"
if [[ -z "${ADMIN_USER}" ]]; then
  ADMIN_USER="admin"
fi
ADMIN_PASS="$(read_env_var XTOOL_ADMIN_PASS || true)"
if [[ -z "${ADMIN_PASS}" ]]; then
  ADMIN_PASS="admin123456"
fi
INSTALL_DIR="$(get_install_dir)"

if [[ -f "${ENV_FILE}" ]]; then
  set -a
  # shellcheck disable=SC1090
  . "${ENV_FILE}"
  set +a
fi

if [[ ! -x "${CTL_BIN}" ]]; then
  echo "xraytoolctl not found: ${CTL_BIN}"
  echo "Please build first: go build -o xraytoolctl ./cmd/xtoolctl"
  exit 1
fi

ensure_public_installer() {
  if [[ -x "${PUBLIC_INSTALLER}" ]]; then
    return 0
  fi
  if command -v curl >/dev/null 2>&1; then
    echo "Downloading installer from GitHub..."
    curl -fsSL "${REPO_INSTALLER_URL}" -o "${PUBLIC_INSTALLER}"
    chmod +x "${PUBLIC_INSTALLER}"
    return 0
  fi
  echo "public-install.sh not found: ${PUBLIC_INSTALLER}"
  echo "Please install curl first or copy installer manually."
  return 1
}

reset_admin() {
  local suggested_user suggested_pass user pass
  suggested_user="admin$(random_alnum 4 | tr 'A-Z' 'a-z')"
  suggested_pass="$(random_alnum 18)"

  read -r -p "New admin username [${suggested_user}] (Enter=random): " user
  if [[ -z "${user}" || "${user}" == "random" || "${user}" == "r" ]]; then
    user="${suggested_user}"
  fi
  read -r -p "New admin password [${suggested_pass}] (Enter=random): " pass
  if [[ -z "${pass}" || "${pass}" == "random" || "${pass}" == "r" ]]; then
    pass="${suggested_pass}"
  fi

  if [[ ${#pass} -lt 8 ]]; then
    echo "Password must be at least 8 chars"
    return 1
  fi

  "${CTL_BIN}" -mode reset-admin -username "${user}" -password "${pass}"

  if [[ -f "${ENV_FILE}" ]]; then
    sed -i.bak -E "s/^XTOOL_ADMIN_USER=.*/XTOOL_ADMIN_USER=${user}/" "${ENV_FILE}"
    sed -i.bak -E "s/^XTOOL_ADMIN_PASS=.*/XTOOL_ADMIN_PASS=${pass}/" "${ENV_FILE}"
  fi

  ADMIN_USER="${user}"
  ADMIN_PASS="${pass}"

  echo
  echo "Admin credentials reset complete:"
  echo "- Username: ${user}"
  echo "- Password: ${pass}"
}

update_service() {
  local version="$1"
  ensure_public_installer || return 1
  bash "${PUBLIC_INSTALLER}" \
    --non-interactive \
    --install-dir "${INSTALL_DIR}" \
    --version "${version}" \
    --port "${PORT_RAW}" \
    --admin-user "${ADMIN_USER}" \
    --admin-pass "${ADMIN_PASS}"
}

uninstall_service() {
  local confirm purge
  read -r -p "Type 'UNINSTALL' to continue: " confirm
  if [[ "${confirm}" != "UNINSTALL" ]]; then
    echo "Cancelled."
    return 1
  fi

  read -r -p "Remove all data and binaries under ${INSTALL_DIR}? [y/N]: " purge

  systemctl disable --now "${SERVICE_NAME}" >/dev/null 2>&1 || true
  rm -f "${UNIT_FILE}"
  rm -f "${ENV_FILE}"
  systemctl daemon-reload

  if [[ "${purge}" == "y" || "${purge}" == "Y" ]]; then
    rm -rf "${INSTALL_DIR}"
    echo "Removed install dir: ${INSTALL_DIR}"
  else
    echo "Kept install dir/data: ${INSTALL_DIR}"
  fi

  echo "Uninstall completed."
}

show_status() {
  echo "Service      : ${SERVICE_NAME}"
  if systemctl is-active --quiet "${SERVICE_NAME}"; then
    echo "Status       : active"
  else
    echo "Status       : inactive"
  fi
  echo "Install dir  : ${INSTALL_DIR}"
  echo "Listen port  : ${PORT_RAW}"
  echo "Admin user   : ${ADMIN_USER}"
}

while true; do
  echo "=============================="
  echo " XrayTool CLI (xtool)"
  echo "=============================="
  echo "1) Reset admin username/password"
  echo "2) One-click update (latest)"
  echo "3) Update to specific version"
  echo "4) One-click uninstall"
  echo "5) Show service status"
  echo "6) Exit"
  read -r -p "Select [1-6]: " choice

  case "${choice}" in
    1)
      reset_admin
      ;;
    2)
      update_service "latest"
      ;;
    3)
      read -r -p "Version tag (e.g. v0.1.3): " version
      if [[ -z "${version}" ]]; then
        echo "Version cannot be empty"
      else
        update_service "${version}"
      fi
      ;;
    4)
      uninstall_service
      ;;
    5)
      show_status
      ;;
    6)
      exit 0
      ;;
    *)
      echo "Invalid selection"
      ;;
  esac
  echo
done
