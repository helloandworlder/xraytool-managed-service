name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26.x'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Build frontend
        working-directory: frontend
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Build binaries
        run: |
          mkdir -p dist
          docker run --rm -v "$PWD":/src -w /src debian:bullseye bash -lc '
            set -euo pipefail
            apt-get update
            apt-get install -y ca-certificates curl gcc-aarch64-linux-gnu
            curl -fsSL https://go.dev/dl/go1.26.0.linux-amd64.tar.gz -o /tmp/go.tgz
            tar -C /usr/local -xzf /tmp/go.tgz
            export PATH=/usr/local/go/bin:$PATH
            CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o dist/xraytool-linux-amd64 ./cmd/xraytool
            CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o dist/xraytoolctl-linux-amd64 ./cmd/xtoolctl
            CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -o dist/xraytool-linux-arm64 ./cmd/xraytool
            CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -o dist/xraytoolctl-linux-arm64 ./cmd/xtoolctl
          '

      - name: Package release bundles
        run: |
          for arch in amd64 arm64; do
            workdir="$(mktemp -d)"
            mkdir -p "${workdir}/release"
            cp "dist/xraytool-linux-${arch}" "${workdir}/release/xraytool"
            cp "dist/xraytoolctl-linux-${arch}" "${workdir}/release/xraytoolctl"
            cp -R deploy "${workdir}/release/deploy"
            cp -R web/dist "${workdir}/release/web-dist"
            cp .env.example "${workdir}/release/.env.example"
            cp README.md "${workdir}/release/README.md"
            tar -C "${workdir}" -czf "dist/xraytool-linux-${arch}.tar.gz" release
            rm -rf "${workdir}"
          done

      - name: Publish GitHub release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/xraytool-linux-amd64
            dist/xraytoolctl-linux-amd64
            dist/xraytool-linux-amd64.tar.gz
            dist/xraytool-linux-arm64
            dist/xraytoolctl-linux-arm64
            dist/xraytool-linux-arm64.tar.gz
